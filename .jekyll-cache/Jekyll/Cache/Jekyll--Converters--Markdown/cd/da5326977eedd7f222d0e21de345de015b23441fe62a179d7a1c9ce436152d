I"Ô(<p>PowerShell is great to use with a Microsoft SQL server. There are plenty of ways to work with a SQL server from <a href="https://docs.microsoft.com/en-us/sql/powershell/download-sql-server-ps-module?view=sql-server-ver16">Microsoft‚Äôs SQL module</a>, by calling the underlying <a href="https://www.delftstack.com/howto/powershell/running-sql-queries-in-powershell/">.NET classes</a>, but recently I found <a href="https://dbatools.io">dbatools</a>!</p>

<!--more-->

<p>What is the best way to describe dbatools? Let‚Äôs take it straight from their <a href="https://dbatools.io/getting-started/">webpage</a>: dbatools is a free PowerShell module with over 500 SQL Server administration, best practice and migration commands included.</p>

<p>While they have a great way to get the <a href="https://dbatools.io/download/">modules installed</a>, I found we needed a few extra items. First PowerShell no longer supports TLS1.0 and we need to enforce TLS1.2 by calling the .NET class for this. I enjoyed the first entry-level taste of dbatools that I wrote a quick script to help get it installed or imported properly at the beginning of the script.</p>

<p>One thing I have found when using extra modules that are not part of the ‚Äúdefault‚Äù core of PowerShell we still need to import the module. This helps the script no matter what to know what the functions are later on and what the script and server are to be using. So how did I get this installed in mass, lets see!</p>

<h2 id="installing-dbatools">Installing dbatools</h2>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">Get-Module</span><span class="w"> </span><span class="nt">-ListAvailable</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nx">dbatools</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">Write-Host</span><span class="w"> </span><span class="s2">"dbatools Module exists"</span><span class="w">
    </span><span class="n">Import-Module</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nx">dbatools</span><span class="w">
</span><span class="p">}</span><span class="w"> 
</span><span class="kr">else</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">Write-Host</span><span class="w"> </span><span class="s2">"dbatools Module does not exist"</span><span class="w">
    </span><span class="n">Install-PackageProvider</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nx">NuGet</span><span class="w"> </span><span class="nt">-MinimumVersion</span><span class="w"> </span><span class="nx">2.8.5.201</span><span class="w"> </span><span class="nt">-Force</span><span class="w">
    </span><span class="p">[</span><span class="n">Net.ServicePointManager</span><span class="p">]::</span><span class="n">SecurityProtocol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Net.SecurityProtocolType</span><span class="p">]::</span><span class="n">Tls12</span><span class="w">
    </span><span class="nx">Install-Module</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nx">dbatools</span><span class="w">
    </span><span class="n">Import-Module</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nx">dbatools</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Having the above at the top of my new and improved SQL script I can always rest easy knowing that I am first checking the system for the module with the <code class="highlighter-rouge">Get-Module</code>. If the module exists, we import it. Otherwise, we need to first set the systems package provider with NuGet and set the TLS settings for the session and install the dbatools module. Then once it is installed, import it with <code class="highlighter-rouge">Import-Module</code> to ensure the install was a success.</p>

<p>Now that we have dabtools installed we can do some fun things to ensure its working.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Find-DbaInstance</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nx">localhost</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select</span><span class="w"> </span><span class="nx">ComputerName</span><span class="p">,</span><span class="nx">SQLInstance</span><span class="w"> </span><span class="nt">-Unique</span><span class="w">
</span></code></pre></div></div>

<p>With this tidbit we can find all the SQL instances on the machine and get the instances running on that server. With this information we might be able to make a selection for the user to confirm the SQL instance to use, then the database to use, etc. All building off of using the commandlets to get the information rather than hard coding or asking the user to pass along variables.</p>

<h2 id="using-dbatools-and-powershell">Using dbatools and PowerShell</h2>

<p>Since dabbling with a few of the commands and what we could do with this new toolset, I found writing SQL queries to be a bit challenging. Lets say we had an input using <code class="highlighter-rouge">Read-Input</code> asking the user for some text that we needed to then use in our query. dabtools does allow the use of SQL files for the queries or they can be directly added to the script. I had a simple script and adding the query to the PowerShell was easier than using and keeping up with yet another file. But how to do this‚Ä¶ that was the issue.</p>

<p>So we setup the user input:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$customer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Read-Host</span><span class="w"> </span><span class="s2">"What is the client name you are looking for?"</span><span class="w">
</span></code></pre></div></div>

<p>Then our query:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$query</span><span class="o">=</span><span class="s2">"SELECT Product,Customer FROM Store WHERE Customer like '%</span><span class="nv">$customer</span><span class="s2">%'"</span><span class="w">
</span></code></pre></div></div>

<p>Then we use our new SQL query command:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Invoke-DbaQuery</span><span class="w"> </span><span class="nt">-SqlInstance</span><span class="w"> </span><span class="nx">localhost</span><span class="w"> </span><span class="nt">-Query</span><span class="w"> </span><span class="nv">$query</span><span class="w">
</span></code></pre></div></div>

<p>This would always not return the result I was looking for. I was thinking logically this query works in SQL or SSMS so why not in PowerShell? The <code class="highlighter-rouge">Invoke-DbaQuery</code> command was not properly handling the ‚Äúembedded‚Äù PowerShell variable into the query. The <code class="highlighter-rouge">Invoke-DbaQuery</code> does allow you to pass along <code class="highlighter-rouge">-SqlParameter</code> and have the variable added that was as well. For me this was still not working. I tried encapsulating the <code class="highlighter-rouge">$customr</code> variable with <code class="highlighter-rouge">$($customer)</code> forcing the string to know this was a variable. Still no luck. Then I remembered.</p>

<p>Just like in C# I‚Äôd have to allow the string to be allow escapes and allow for a multi-line variable. This also helped with formatting. So our query from early became:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$query</span><span class="o">=</span><span class="sh">@"
SELECT Product,Customer 
FROM Store 
WHERE Customer like '%</span><span class="si">$(</span><span class="nv">$customer</span><span class="si">)</span><span class="sh">%'
"@</span><span class="w">
</span></code></pre></div></div>

<p>After making the change here the query worked as it should and output to the screen. To better manipulate the output I found that I could put the <code class="highlighter-rouge">Invoke-DbaQuery</code> into a variable <code class="highlighter-rouge">$output</code> and then pass it along to the <code class="highlighter-rouge">Out-GridView</code> where PowerShell takes the results and makes a pretty GUI window that you can use as well.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$output</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Out-GridView</span><span class="w">
</span></code></pre></div></div>

<p>Then to wrap up the script it is always good to properly close your connections to SQL. dbatools has a way to <code class="highlighter-rouge">Get-DbaConnections</code> and just like other PowerShell commands, pass this to the <code class="highlighter-rouge">Disconnect-DbaInstance</code>. I then passed this to <code class="highlighter-rouge">Out-Null</code> just so that way I didn‚Äôt have to see the connections or disconnections in the script, since I knew the database instance already.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># disconnect SQL Connections</span><span class="w">
</span><span class="n">Get-DbaConnectedInstance</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Disconnect-DbaInstance</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span></code></pre></div></div>

<p>Hope now you can find a great use for <a href="https://dbatools.io">dbatools</a> like I have. I plan on using the database migration, backup, and clone functions as well.</p>
:ET